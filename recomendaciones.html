<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Api Connect — Recomendaciones</title>

  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin/>
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Work+Sans:wght@400;500;600;700&family=Noto+Sans:wght@400;500;700;900" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <style>
    :root{
      --primary:#f2b90d; --bg:#fcfbf8; --ink:#1c180d; --muted:#706b5e; --accent:#e5e7eb;
      --ok:#16a34a; --warn:#f59e0b;
    }
    body{ font-family:"Work Sans","Noto Sans",sans-serif; background:var(--bg); color:var(--ink); }
    .card-ok{ border:1px solid #bbf7d0; background:#f0fdf4; }
    .card-warn{ border:1px solid #fed7aa; background:#fff7ed; }
    .pill{ padding:.25rem .6rem; border-radius:999px; font-size:.75rem; font-weight:600; }
  </style>
</head>
<body>
  <div class="relative flex min-h-screen flex-col">
    <div class="flex grow">
      <!-- Sidebar -->
      <aside class="flex flex-col w-full lg:w-64 bg-[var(--bg)] p-4 shrink-0">
        <div class="flex items-center gap-3 mb-8">
          <img class="rounded-full size-10" alt="Api Connect" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDo_G5n2qj-AtjsBpj4fWvqM5-adZ3ydAOkO6tUmmrftlf3ddMGOAF_LhA3bNYR1FxX5h8p27BqfcHn5AiJ0uGLn8M4B8qV-wCaDz3mG-EcY9uBnXlYkRTmWw5_MG72dpx6UbblS2hNE-sY26FG0uteRs5z0DTwB2rxKJH4BW9919pi6LiiE5D_qX0NDlYZO0jB4J9ewgzc-FRJqvvc1JnTWw5YuOZjyErh2aFrYJ6l3tEegI6MOqk1fz6wmT0iuL7L5NPL1UVjR0A"/>
          <h1 class="text-lg font-semibold">Api Connect</h1>
        </div>
        <nav class="flex-1 flex flex-col gap-2">
          <a class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-yellow-50" href="dashboard.html">
            <span class="material-symbols-outlined text-[var(--muted)]">home</span><span class="text-sm font-medium">Panel</span>
          </a>
          <a class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-yellow-50" href="history.html">
            <span class="material-symbols-outlined text-[var(--muted)]">history</span><span class="text-sm font-medium">Historial</span>
          </a>
          <a class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-yellow-50" href="lotes.html">
            <span class="material-symbols-outlined text-[var(--muted)]">inventory_2</span><span class="text-sm font-medium">Producción</span>
          </a>
          <a class="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-yellow-50" href="thresholds.html">
            <span class="material-symbols-outlined text-[var(--muted)]">tune</span><span class="text-sm font-medium">Umbrales</span>
          </a>
          <a class="flex items-center gap-3 px-3 py-2 rounded-md bg-[var(--primary)]" href="recomendaciones.html">
            <span class="material-symbols-outlined">lightbulb</span><span class="text-sm font-semibold">Recomendaciones</span>
          </a>
        </nav>
      </aside>

      <!-- Main -->
      <main class="flex-1 p-6 lg:p-10 bg-white rounded-tl-3xl">
        <div class="max-w-5xl mx-auto">
          <header class="mb-8">
            <h2 class="text-4xl font-bold tracking-tight">Recomendaciones del Sistema</h2>
            <p class="text-[var(--muted)] mt-2">Estimaciones inteligentes basadas en tus umbrales y métricas recientes.</p>
          </header>

          <!-- Controles -->
          <section class="mb-6 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
            <div class="flex items-center gap-2">
              <input id="q" type="text" placeholder="Buscar colmena…" class="form-input rounded-md border-gray-300">
              <button id="btnSim" class="px-3 py-2 rounded-md bg-[var(--primary)] font-semibold hover:brightness-110">Simular datos</button>
            </div>
            <div class="flex items-center gap-3">
              <span class="pill bg-green-100 text-green-800">Listo: <b id="countOk">0</b></span>
              <span class="pill bg-orange-100 text-orange-800">Esperar: <b id="countWait">0</b></span>
            </div>
          </section>

          <!-- Listo -->
          <section>
            <h3 class="text-2xl font-semibold tracking-tight mb-3">Recomendaciones de Cosecha</h3>
            <div id="listOk" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
          </section>

          <!-- Espera -->
          <section class="mt-10">
            <h3 class="text-2xl font-semibold tracking-tight mb-3">Recomendaciones de Espera</h3>
            <div id="listWait" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal detalle -->
  <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6">
      <div class="flex items-center justify-between mb-2">
        <h4 class="text-xl font-bold">Detalle de recomendación</h4>
        <button id="mClose" class="p-1 rounded hover:bg-gray-100"><span class="material-symbols-outlined">close</span></button>
      </div>
      <p id="mTitle" class="text-sm text-gray-600 mb-4"></p>
      <ul id="mReasons" class="list-disc pl-5 text-sm text-gray-800 space-y-1"></ul>
      <div class="mt-5 text-right">
        <button id="mOk" class="px-4 py-2 rounded-md bg-[var(--primary)] font-semibold hover:brightness-110">Entendido</button>
      </div>
    </div>
  </div>

  <script>
    // ------- Datos (puedes reemplazar por fetch a tu backend) -------
    const seedHives = [
      { id: 'Colmena 1', t: 32, h: 62, w: 27.5, trendW: +0.8, days: 18 },
      { id: 'Colmena 2', t: 31, h: 60, w: 26.9, trendW: +0.6, days: 15 },
      { id: 'Colmena 3', t: 30, h: 65, w: 28.2, trendW: +0.3, days: 22 },
      { id: 'Colmena 4', t: 29, h: 58, w: 24.0, trendW: +0.4, days: 10 },
      { id: 'Colmena 5', t: 33, h: 72, w: 21.5, trendW: +0.2, days: 7  },
      { id: 'Colmena 6', t: 27, h: 66, w: 19.0, trendW: -0.1, days: 5  },
      { id: 'Colmena 7', t: 34, h: 69, w: 22.3, trendW: +0.1, days: 9  },
      { id: 'Colmena 8', t: 28, h: 55, w: 18.7, trendW: +0.3, days: 6  },
    ];

    // ------- Umbrales desde localStorage (thresholds.html) -------
    function getThresholds(){
      const raw = localStorage.getItem('api-connect-thresholds');
      const def = { temp:{min:10,max:35}, hum:{min:40,max:70}, w:{min:5,max:20} };
      if(!raw) return def;
      try { return Object.assign(def, JSON.parse(raw)); } catch { return def; }
    }

    // ------- Regla de decisión (simple y transparente) -------
    // "Listo para cosechar" si:
    // 1) t y h dentro del rango,
    // 2) peso >= 75% del peso máximo configurado,
    // 3) tendencia de peso no es claramente negativa,
    // 4) han pasado >= 14 días desde última cosecha.
    function decide(hive, thr){
      const reasons = [];
      const okTemp = hive.t >= thr.temp.min && hive.t <= thr.temp.max;
      const okHum  = hive.h >= thr.hum.min  && hive.h <= thr.hum.max;
      const target = thr.w.max * 0.75;
      const okW    = hive.w >= target;
      const okTrend= hive.trendW >= -0.05; // caídas fuertes detienen la cosecha
      const okDays = hive.days >= 14;

      if(!okTemp) reasons.push(`Temperatura fuera de rango (${hive.t}°C, permitido ${thr.temp.min}–${thr.temp.max})`);
      if(!okHum)  reasons.push(`Humedad fuera de rango (${hive.h}%, permitido ${thr.hum.min}–${thr.hum.max})`);
      if(!okW)    reasons.push(`Peso ${hive.w} kg por debajo del objetivo (≥ ${target.toFixed(1)} kg)`);
      if(!okTrend)reasons.push(`Tendencia de peso negativa (${hive.trendW >= 0 ? '+' : ''}${hive.trendW} kg/día)`);
      if(!okDays) reasons.push(`Muy pronto desde la última cosecha (${hive.days} días, mínimo 14)`);

      const ok = okTemp && okHum && okW && okTrend && okDays;
      return { ok, reasons, target };
    }

    // ------- Render -------
    const $ = s => document.querySelector(s);
    const listOk   = $('#listOk');
    const listWait = $('#listWait');
    const q        = $('#q');
    const countOk  = $('#countOk');
    const countWait= $('#countWait');

    function card(h, verdict){
      const cls = verdict.ok ? 'card-ok' : 'card-warn';
      const icon = verdict.ok ? 'check_circle' : 'hourglass_top';
      const tone = verdict.ok ? 'text-green-600 bg-green-100' : 'text-orange-600 bg-orange-100';
      const title= verdict.ok ? 'Listo para cosechar' : 'Esperar';
      return `
      <div class="flex items-center justify-between p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow ${cls}">
        <div class="flex items-center gap-4">
          <div class="flex items-center justify-center size-12 rounded-full ${tone}">
            <span class="material-symbols-outlined text-3xl">${icon}</span>
          </div>
          <div>
            <p class="font-semibold">${title}</p>
            <p class="text-sm ${verdict.ok ? 'text-green-800' : 'text-orange-800'}">${h.id}</p>
            <p class="text-xs text-gray-500 mt-0.5">t:${h.t}°C • h:${h.h}% • w:${h.w}kg • Δw:${h.trendW>=0?'+':''}${h.trendW}kg/día • ${h.days} días</p>
          </div>
        </div>
        <button class="px-2 py-1 rounded hover:bg-white/60 text-sm font-medium detail-btn" data-id="${h.id}">Detalles</button>
      </div>`;
    }

    function render(){
      const thr = getThresholds();
      const term = (q.value||'').toLowerCase();
      const okCards = [];
      const waitCards = [];
      const data = (JSON.parse(localStorage.getItem('demo-hives')||'null') || seedHives);

      data
        .filter(h => !term || h.id.toLowerCase().includes(term))
        .forEach(h => {
          const verdict = decide(h, thr);
          (verdict.ok ? okCards : waitCards).push(card(h, verdict));
        });

      listOk.innerHTML   = okCards.join('') || `<p class="text-sm text-gray-500">Sin coincidencias.</p>`;
      listWait.innerHTML = waitCards.join('') || `<p class="text-sm text-gray-500">Sin coincidencias.</p>`;
      countOk.textContent   = okCards.length;
      countWait.textContent = waitCards.length;
    }

    q.addEventListener('input', render);

    // ------- Simulación (para demo) -------
    // Ajusta un poco t, h, w y días para "mover" recomendaciones.
    $('#btnSim').addEventListener('click', ()=>{
      const base = JSON.parse(JSON.stringify(seedHives));
      const jitter = () => (Math.random()*2-1); // -1..+1
      base.forEach(h=>{
        h.t = Number((h.t + jitter()).toFixed(1));
        h.h = Math.min(100, Math.max(0, Number((h.h + jitter()*2).toFixed(0))));
        h.w = Math.max(0, Number((h.w + jitter()*0.8).toFixed(1)));
        h.trendW = Number((h.trendW + jitter()*0.2).toFixed(2));
        h.days = Math.max(0, h.days + Math.round(jitter()*2));
      });
      localStorage.setItem('demo-hives', JSON.stringify(base));
      render();
    });

    // ------- Modal Detalle -------
    const modal = $('#modal'), mClose = $('#mClose'), mOk = $('#mOk'), mTitle = $('#mTitle'), mReasons = $('#mReasons');
    function openModal(h){
      const thr = getThresholds();
      const v = decide(h, thr);
      mTitle.textContent = `${h.id} — ${v.ok ? 'Listo para cosechar' : 'Esperar'}`;
      mReasons.innerHTML = '';
      if(v.reasons.length === 0){
        mReasons.innerHTML = `<li>Todos los criterios se cumplen.</li>
          <li>Peso objetivo (75% de ${thr.w.max} kg): ${v.target.toFixed(1)} kg.</li>`;
      }else{
        v.reasons.forEach(r => {
          const li = document.createElement('li');
          li.textContent = r;
          mReasons.appendChild(li);
        });
      }
      modal.classList.remove('hidden'); modal.classList.add('flex');
    }
    function closeModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
    mClose.addEventListener('click', closeModal);
    mOk.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

    // Delegación para botones "Detalles"
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.detail-btn');
      if(!btn) return;
      const id = btn.dataset.id;
      const data = JSON.parse(localStorage.getItem('demo-hives')||'null') || seedHives;
      const h = data.find(x => x.id === id);
      if(h) openModal(h);
    });

    // Init
    render();
  </script>
</body>
</html>
